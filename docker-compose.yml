version: '3.3'

services:
  rabbit:
    image: rabbitmq:3.9-management
    container_name: "rabbitmq"
    environment:
        - RABBITMQ_DEFAULT_USER=guest
        - RABBITMQ_DEFAULT_PASS=guest
    ports:
        - "5672:5672"
        - "15672:15672"

  postgres:
    image: postgres:13.6
    container_name: "postgres"
    environment:
        - POSTGRES_DB=schedule
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=qwerty
    ports:
        - "5432:5432"

  user:
    container_name: "user"
    build:
        context: ./user
        dockerfile: ./Dockerfile
    depends_on:
        - postgres
    ports:
        - "8080:8080"
    environment:
        - POSTGRES_HOSTS=postgres:5432
        - POSTGRES_DB=schedule
        - POSTGRES_USER=postgres
        - POSTGRES_PWD=qwerty

  registration:
    container_name: "registration"
    build:
        context: ./registration
        dockerfile: ./Dockerfile
    depends_on:
        - postgres
        - user
        - rabbit
    ports:
        - "8081:8081"
    environment:
        - POSTGRES_HOSTS=postgres:5432
        - POSTGRES_DB=schedule
        - POSTGRES_USER=postgres
        - POSTGRES_PWD=qwerty
        - RABBIT_HOST=rabbit
        - RABBIT_PORT=5672
        - RABBIT_USERNAME=guest
        - RABBIT_PASSWORD=guest
        - SERVER_PORT=8081
        - RABBIT_QUEUE=mail_processed
        - USER_SERVICE_HOSTS=user:8080

  email:
    container_name: "email"
    build:
        context: ./email
        dockerfile: ./Dockerfile
    depends_on:
        - rabbit
    environment:
        - RABBIT_QUEUE=mail_processed
        - RABBITMQ_USER=guest
        - RABBITMQ_PASS=guest
        - RABBITMQ_HOST=rabbit
        - RABBITMQ_PORT=5672
        - FROM_EMAIL=teamscheduleservice@gmail.com
        - FROM_EMAIL_PASSWORD=teamscheduleservice1%

  jwt:
    container_name: "jwt"
    build:
        context: ./jwt
        dockerfile: ./Dev.dockerfile
    depends_on:
        - user
    ports:
        - "8082:8082"
    volumes:
        - ./jwt:/jwt
    environment:
        - JWT_SECRET_KEY=kXpBmV^_|BFq#c.-""B:cd#k6-/EuVp]
        - USER_SERVICE_HOSTS=user:8080

  nginx:
    container_name: "nginx"
    build:
        context: ./nginx
        dockerfile: ./Dev.dockerfile
    depends_on:
        - jwt
        - email
        - registration
        - user
        - postgres
        - rabbit
    ports:
        - "80:80"
    volumes:
        - ./nginx/static/:/nginx/static

  client:
    container_name: "client"
    build:
        context: ./client
        dockerfile: ./Dev.dockerfile
    ports:
        - "3000:3000"
    volumes:
        - ./client:/app
